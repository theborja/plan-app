generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum PlanSourceType {
  IMPORTED_EXCEL
  MANUAL
}

enum DayOfWeek {
  Mon
  Tue
  Wed
  Thu
  Fri
  Sat
  Sun
}

enum MealType {
  DESAYUNO
  ALMUERZO
  COMIDA
  MERIENDA
  CENA
  POSTRE
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  passwordHash      String
  name              String
  role              UserRole           @default(USER)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  sessions          Session[]
  plans             UserPlan[]         @relation("UserPlans")
  importedPlans     UserPlan[]         @relation("ImportedPlans")
  settings          UserSettings?
  workoutSessions   WorkoutSession[]
  mealSelectionLogs MealSelectionLog[]
  weeklyMeasures    WeeklyMeasure[]
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model UserPlan {
  id               String             @id @default(cuid())
  userId           String
  name             String
  sourceFileName   String
  sourceType       PlanSourceType
  importedByUserId String
  isActive         Boolean            @default(false)
  importedAt       DateTime           @default(now())
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  user             User               @relation("UserPlans", fields: [userId], references: [id], onDelete: Cascade)
  importedByUser   User               @relation("ImportedPlans", fields: [importedByUserId], references: [id], onDelete: Restrict)
  trainingDays     TrainingDay[]
  nutritionDays    NutritionDay[]
  workoutSessions  WorkoutSession[]
  mealSelections   MealSelectionLog[]

  @@index([userId, isActive])
  @@index([userId, importedAt(sort: Desc)])
}

model TrainingDay {
  id        String           @id @default(cuid())
  planId    String
  dayIndex  Int
  label     String
  sortOrder Int
  plan      UserPlan         @relation(fields: [planId], references: [id], onDelete: Cascade)
  exercises Exercise[]
  sessions  WorkoutSession[]

  @@unique([planId, dayIndex])
  @@index([planId, sortOrder])
}

model Exercise {
  id            String           @id @default(cuid())
  trainingDayId String
  exerciseIndex Int
  name          String
  sets          Int?
  reps          String?
  restSeconds   Int?
  notes         String?
  trainingDay   TrainingDay      @relation(fields: [trainingDayId], references: [id], onDelete: Cascade)
  setLogs       ExerciseSetLog[]

  @@unique([trainingDayId, exerciseIndex])
  @@index([trainingDayId])
}

model NutritionDay {
  id          String                @id @default(cuid())
  planId      String
  weekIndex   Int
  dayOfWeek   DayOfWeek
  sortOrder   Int
  plan        UserPlan              @relation(fields: [planId], references: [id], onDelete: Cascade)
  mealOptions NutritionMealOption[]

  @@unique([planId, weekIndex, dayOfWeek])
  @@index([planId, sortOrder])
}

model NutritionMealOption {
  id             String              @id @default(cuid())
  nutritionDayId String
  mealType       MealType
  optionIndex    Int
  title          String
  nutritionDay   NutritionDay        @relation(fields: [nutritionDayId], references: [id], onDelete: Cascade)
  lines          NutritionMealLine[]

  @@unique([nutritionDayId, mealType, optionIndex])
  @@index([nutritionDayId, mealType])
}

model NutritionMealLine {
  id           String              @id @default(cuid())
  mealOptionId String
  lineIndex    Int
  content      String
  mealOption   NutritionMealOption @relation(fields: [mealOptionId], references: [id], onDelete: Cascade)

  @@unique([mealOptionId, lineIndex])
}

model UserSettings {
  id                    String      @id @default(cuid())
  userId                String      @unique
  nutritionStartDateISO String
  trainingDays          DayOfWeek[]
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WorkoutSession {
  id            String           @id @default(cuid())
  userId        String
  planId        String
  trainingDayId String
  dateISO       String
  note          String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan          UserPlan         @relation(fields: [planId], references: [id], onDelete: Cascade)
  trainingDay   TrainingDay      @relation(fields: [trainingDayId], references: [id], onDelete: Cascade)
  setLogs       ExerciseSetLog[]

  @@unique([userId, dateISO])
  @@index([userId, dateISO])
}

model ExerciseSetLog {
  id         String         @id @default(cuid())
  sessionId  String
  exerciseId String
  setNumber  Int
  weightKg   Float?
  repsDone   Int?
  done       Boolean?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  session    WorkoutSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exercise   Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([sessionId, exerciseId, setNumber])
  @@index([exerciseId])
}

model MealSelectionLog {
  id                  String   @id @default(cuid())
  userId              String
  planId              String
  dateISO             String
  selectedDayOptionId String?
  done                Boolean  @default(false)
  note                String?
  updatedAt           DateTime @updatedAt
  createdAt           DateTime @default(now())
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                UserPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([userId, dateISO])
  @@index([userId, dateISO])
}

model WeeklyMeasure {
  id           String   @id @default(cuid())
  userId       String
  weekStartISO String
  weightKg     Float?
  neckCm       Float?
  armCm        Float?
  waistCm      Float?
  abdomenCm    Float?
  hipCm        Float?
  thighCm      Float?
  note         String?
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStartISO])
  @@index([userId, weekStartISO])
}
