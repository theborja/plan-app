generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum PlanSourceType {
  IMPORTED_EXCEL
  MANUAL
}

enum MealType {
  DESAYUNO
  ALMUERZO
  COMIDA
  POSTRE_COMIDA
  MERIENDA
  CENA
  POSTRE_CENA
}

enum Weekday {
  Mon
  Tue
  Wed
  Thu
  Fri
  Sat
  Sun
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  passwordHash    String
  name            String
  role            UserRole         @default(USER)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  sessions        Session[]
  plans           Plan[]
  workoutSessions WorkoutSession[]
  mealSelections  MealSelectionLog[]
  weeklyMeasures  WeeklyMeasureLog[]
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Plan {
  id                 String              @id @default(cuid())
  userId             String
  name               String
  sourceFileName     String
  sourceType         PlanSourceType      @default(IMPORTED_EXCEL)
  isActive           Boolean             @default(false)
  importedAt         DateTime            @default(now())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  trainingDays       TrainingDay[]
  nutritionDayOptions NutritionDayOption[]
  workoutSessions    WorkoutSession[]
  mealSelectionLogs  MealSelectionLog[]

  @@index([userId, isActive])
  @@index([userId, importedAt])
}

model TrainingDay {
  id              String           @id @default(cuid())
  planId          String
  dayIndex        Int
  label           String
  sortOrder       Int
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  plan            Plan             @relation(fields: [planId], references: [id], onDelete: Cascade)
  exercises       Exercise[]
  workoutSessions WorkoutSession[]

  @@unique([planId, dayIndex])
  @@index([planId, sortOrder])
}

model Exercise {
  id            String           @id @default(cuid())
  trainingDayId String
  exerciseIndex Int
  name          String
  sets          Int?
  reps          String?
  restSeconds   Int?
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  trainingDay   TrainingDay      @relation(fields: [trainingDayId], references: [id], onDelete: Cascade)
  setLogs       ExerciseSetLog[]

  @@unique([trainingDayId, exerciseIndex])
  @@index([trainingDayId])
}

model NutritionDayOption {
  id             String          @id @default(cuid())
  planId         String
  weekIndex      Int
  dayOfWeek      Weekday
  dayOptionIndex Int
  label          String
  sortOrder      Int
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  plan           Plan            @relation(fields: [planId], references: [id], onDelete: Cascade)
  meals          NutritionMeal[]

  @@unique([planId, dayOptionIndex])
  @@unique([planId, weekIndex, dayOfWeek])
  @@index([planId, sortOrder])
}

model NutritionMeal {
  id                    String             @id @default(cuid())
  nutritionDayOptionId  String
  mealType              MealType
  content               String
  sortOrder             Int
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  nutritionDayOption    NutritionDayOption @relation(fields: [nutritionDayOptionId], references: [id], onDelete: Cascade)

  @@index([nutritionDayOptionId, mealType])
}

model WorkoutSession {
  id            String           @id @default(cuid())
  userId        String
  planId        String
  trainingDayId String
  dateISO       String
  note          String?
  completed     Boolean          @default(false)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan          Plan             @relation(fields: [planId], references: [id], onDelete: Cascade)
  trainingDay   TrainingDay      @relation(fields: [trainingDayId], references: [id], onDelete: Cascade)
  setLogs       ExerciseSetLog[]

  @@unique([userId, planId, dateISO])
  @@index([userId, dateISO])
}

model ExerciseSetLog {
  id        String         @id @default(cuid())
  sessionId String
  exerciseId String
  setNumber Int
  weight    Float?
  repsDone  Int?
  done      Boolean?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  session   WorkoutSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exercise  Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([sessionId, exerciseId, setNumber])
  @@index([exerciseId])
}

model MealSelectionLog {
  id                     String   @id @default(cuid())
  userId                 String
  planId                 String
  dateISO                String
  selectedDayOptionIndex Int?
  done                   Boolean  @default(false)
  note                   String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                   Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([userId, planId, dateISO])
  @@index([userId, dateISO])
}

model WeeklyMeasureLog {
  id          String   @id @default(cuid())
  userId      String
  weekStartISO String
  weightKg    Float?
  neckCm      Float?
  armCm       Float?
  waistCm     Float?
  abdomenCm   Float?
  hipCm       Float?
  thighCm     Float?
  note        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStartISO])
  @@index([userId, weekStartISO])
}
